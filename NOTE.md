# 警报系统

## 预期目标和问题

暂定目标：从`Elasticsearch`中获取错误日志信息，然后预警。

需要解决的问题：

1. 不同的项目使用的 ES 服务地址是不同的，需要能够方便地配置这个地址
2. 不同项目 ES 查询条件是不同的，需要能让业务灵活地搭配条件，而且还得给出预览查询效果
3. 预警是需要往企业微信群推送消息的，所以需要给出配置微信群机器人接口的地方
4. 推送出去的消息，是文字来的，这就需要模板，让业务灵活填写推送的消息
5. 推送出去的消息可以嵌入可替换的变量，而这些变量是根据 ES 返回结果得到的。显然需要一些预置的变量
6. 看实际情况可能还需要用变量使用到 ES 查询的结果中的某些属性，或者从日志消息中提取某些内容。如何做到让业务在网页端就能编程做这些筛选、提取工作呢？
7. 上面的信息提取需要做预览，否则业务调试很困难
8. 接下来是触发以上任务的时间、频率。需要给定推送的频率配置，时间配置，否则推送太频繁会出问题，推送频率太低消息不及时

## 可能的解决方案（大概）

1. 任务配置页面用两个输入矿：host和ip，默认采用host，配置 ES 地址。同时允许配置开启https选项
2. 利用 ES 提供的 query_string 功能，开放查询字符串。需要额外指定的 index 等，增加输入框填写，需要的时候查询 ES 给出下拉选项
3. 给出配置推送地址的输入框
4. 给出消息内容输入文本框，用户可以自己额外指定什么符号是变量就行了。
5. 像消息总条数这种可以预置
6. 针对第 4 点用户自己定义的符号，每一个都配置开始符号和终止符号，然后从每个匹配到的日志中解析出这些变量，然后转换成逗号分割的内容赋值给用户定义的符号
7. 用户在定义匹配的起始和终止符号的时候，给一个测试的按钮，可以用来执行和查看效果
8. PID之类的算法给出配置，限制触发警报后的推送频率上限就行了

## 概念

### 导航栏目（进入的全部页面）

1. 任务列表
2. 任务配置
    1. ES 地址配置子页面，配置 host 和 ip，配置 https，配置请求头，配置登录校验的用户名和密码，配置 User Agent
    2. ES 查询条件页面。下拉选项指定`info`或者`error`，给出输入框让用户自己填写 query_string，设置查询条目限制
    3. 企业微信机器人推送地址填写页面
    4. 推送文本消息提示填写页面，提示可以嵌入占位符
    5. 占位符配置页面，定义占位符，并测试占位符
    6. 推送频率配置页面

